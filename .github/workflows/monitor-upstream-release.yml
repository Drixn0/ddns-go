name: ç›‘æµ‹åŸä»“åº“æ–°Releaseå¹¶è§¦å‘å‘å¸ƒ
on:
  cron: '0 * * * *'  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼ˆå¯è°ƒæ•´ï¼Œå¦‚æ¯å¤©ï¼š'0 7 * * *'ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  monitor-and-trigger:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€æƒé™åˆ›å»ºæ ‡ç­¾ã€æ¨é€ä»£ç 
    steps:
      ########################################################################
      # æ­¥éª¤1ï¼šæ£€å‡ºè‡ªå·±çš„ä»“åº“ï¼ˆç”¨äºåˆ›å»ºæ ‡ç­¾ï¼‰
      ########################################################################
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œç¡®ä¿èƒ½è¯»å–å·²æœ‰æ ‡ç­¾

      ########################################################################
      # æ­¥éª¤2ï¼šè·å–åŸä»“åº“çš„æœ€æ–°Releaseæ ‡ç­¾
      ########################################################################
      - name: è·å–åŸä»“åº“æœ€æ–°Releaseæ ‡ç­¾
        id: get_upstream_release
        env:
          UPSTREAM_OWNER: 'jeessy2'  # ğŸ”´ æ”¹ä¸ºåŸä»“åº“ä½œè€…ï¼ˆå¦‚jeessy2ï¼‰
          UPSTREAM_REPO: 'ddns-go'       # ğŸ”´ æ”¹ä¸ºåŸä»“åº“åç§°ï¼ˆå¦‚ddns-goï¼‰
        run: |
          # è°ƒç”¨GitHub APIè·å–åŸä»“åº“æœ€æ–°Releaseï¼ˆå…¬å¼€ä»“åº“æ— éœ€è®¤è¯ï¼‰
          RESPONSE=$(curl -s "https://api.github.com/repos/$UPSTREAM_OWNER/$UPSTREAM_REPO/releases/latest")

          # è§£æAPIå“åº”ï¼Œæå–æ ‡ç­¾åï¼ˆè‹¥åŸä»“åº“æ— Releaseï¼Œä¼šè¿”å›404ï¼Œæ­¤å¤„å¤„ç†ä¸ºæ— æ ‡ç­¾ï¼‰
          UPSTREAM_TAG=$(echo "$RESPONSE" | jq -r '.tag_name')

          # éªŒè¯æ ‡ç­¾æ ¼å¼ï¼ˆç¡®ä¿æ˜¯v*æ ¼å¼ï¼Œé¿å…éç‰ˆæœ¬æ ‡ç­¾ï¼‰
          if [[ $UPSTREAM_TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "æ£€æµ‹åˆ°åŸä»“åº“æœ€æ–°Releaseæ ‡ç­¾ï¼š$UPSTREAM_TAG"
            echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          else
            echo "åŸä»“åº“æ— æœ‰æ•ˆReleaseæ ‡ç­¾ï¼ˆæˆ–æ ¼å¼ä¸ç¬¦åˆv*ï¼‰ï¼Œæ ‡ç­¾å€¼ï¼š$UPSTREAM_TAG"
            echo "upstream_tag=" >> $GITHUB_OUTPUT  # è¾“å‡ºç©ºå€¼ï¼Œåç»­æ­¥éª¤ä¼šè·³è¿‡
          fi

      ########################################################################
      # æ­¥éª¤3ï¼šè¯»å–æœ¬åœ°ç¼“å­˜çš„ä¸Šæ¬¡æ£€æµ‹åˆ°çš„æ ‡ç­¾ï¼ˆç”¨äºå¯¹æ¯”æ˜¯å¦æœ‰æ–°Releaseï¼‰
      ########################################################################
      - name: è¯»å–ä¸Šæ¬¡æ£€æµ‹åˆ°çš„æ ‡ç­¾ç¼“å­˜
        id: cache_last_tag
        uses: actions/cache@v3
        with:
          path: last_upstream_tag  # ç¼“å­˜æ–‡ä»¶è·¯å¾„ï¼ˆå­˜å‚¨ä¸Šæ¬¡çš„æ ‡ç­¾ï¼‰
          key: ${{ runner.os }}-upstream-tag  # ç¼“å­˜é”®å

      ########################################################################
      # æ­¥éª¤4ï¼šå¯¹æ¯”æ ‡ç­¾ï¼Œè‹¥æœ‰æ–°Releaseåˆ™åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾ï¼ˆè§¦å‘release.ymlï¼‰
      ########################################################################
      - name: æ£€æµ‹åˆ°æ–°Releaseï¼Œè§¦å‘è‡ªå·±çš„release.yml
        if: steps.get_upstream_release.outputs.upstream_tag != '' && steps.get_upstream_release.outputs.upstream_tag != steps.cache_last_tag.outputs.cache-hit
        env:
          NEW_TAG: ${{ steps.get_upstream_release.outputs.upstream_tag }}  # åŸä»“åº“çš„æ–°æ ‡ç­¾ï¼ˆå¦‚v1.2.3ï¼‰
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. æ£€æŸ¥è‡ªå·±çš„ä»“åº“æ˜¯å¦å·²å­˜åœ¨è¯¥æ ‡ç­¾ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
          if git show-ref --verify --quiet "refs/tags/$NEW_TAG"; then
            echo "è‡ªå·±çš„ä»“åº“å·²å­˜åœ¨æ ‡ç­¾ $NEW_TAGï¼Œæ— éœ€é‡å¤åˆ›å»º"
          else
            # 2. åˆ›å»ºæ ‡ç­¾ï¼ˆä¸åŸä»“åº“Releaseæ ‡ç­¾ä¸€è‡´ï¼‰
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git tag -a $NEW_TAG -m "åŒæ­¥åŸä»“åº“Release: $NEW_TAG"
            # 3. æ¨é€æ ‡ç­¾åˆ°è‡ªå·±çš„ä»“åº“ï¼ˆè§¦å‘release.ymlï¼‰
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git $NEW_TAG
            echo "å·²æ¨é€æ ‡ç­¾ $NEW_TAGï¼Œè§¦å‘ release.yml å·¥ä½œæµ"
          fi

      ########################################################################
      # æ­¥éª¤5ï¼šæ›´æ–°ç¼“å­˜ï¼ˆå°†æœ¬æ¬¡æ£€æµ‹åˆ°çš„æ ‡ç­¾å­˜å…¥ç¼“å­˜ï¼Œä¾›ä¸‹æ¬¡å¯¹æ¯”ï¼‰
      ########################################################################
      - name: æ›´æ–°æ ‡ç­¾ç¼“å­˜ï¼ˆè®°å½•æœ¬æ¬¡æ£€æµ‹åˆ°çš„æ ‡ç­¾ï¼‰
        if: steps.get_upstream_release.outputs.upstream_tag != ''
        run: |
          echo "${{ steps.get_upstream_release.outputs.upstream_tag }}" > last_upstream_tag

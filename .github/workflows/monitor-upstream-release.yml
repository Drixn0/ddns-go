name: 监测原仓库新Release并触发发布
on:
  schedule:  # 注意：定时任务必须放在 schedule 字段下，而非直接写 cron
    - cron: '0 * * * *'  # 每小时检查一次（正确缩进：比 on 多 2 个空格）
  workflow_dispatch:  # 允许手动触发（与 schedule 同级）

jobs:
  monitor-and-trigger:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出仓库
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: 获取原仓库最新Release标签
        id: get_upstream_release
        env:
          UPSTREAM_OWNER: 'jeessy2'  # 替换为实际值
          UPSTREAM_REPO: 'ddns-go'       # 替换为实际值
        run: |
          RESPONSE=$(curl -s "https://api.github.com/repos/$UPSTREAM_OWNER/$UPSTREAM_REPO/releases/latest")
          UPSTREAM_TAG=$(echo "$RESPONSE" | jq -r '.tag_name')
          if [[ $UPSTREAM_TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          else
            echo "upstream_tag=" >> $GITHUB_OUTPUT
          fi

      - name: 读取上次检测到的标签缓存
        id: cache_last_tag
        uses: actions/cache@v3
        with:
          path: last_upstream_tag
          key: ${{ runner.os }}-upstream-tag

      - name: 检测到新Release，触发自己的release.yml
        if: steps.get_upstream_release.outputs.upstream_tag != '' && steps.get_upstream_release.outputs.upstream_tag != steps.cache_last_tag.outputs.cache-hit
        env:
          NEW_TAG: ${{ steps.get_upstream_release.outputs.upstream_tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git show-ref --verify --quiet "refs/tags/$NEW_TAG"; then
            echo "标签 $NEW_TAG 已存在"
          else
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git tag -a $NEW_TAG -m "同步原仓库Release: $NEW_TAG"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git $NEW_TAG
          fi

      - name: 更新标签缓存
        if: steps.get_upstream_release.outputs.upstream_tag != ''
        run: |
          echo "${{ steps.get_upstream_release.outputs.upstream_tag }}" > last_upstream_tag
